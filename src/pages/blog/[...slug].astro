---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

function formatDate(date: Date): string {
  return date.toISOString().split('T')[0];
}

// 过滤出 h2 和 h3 标题用于目录
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

<Layout title={`${post.data.title} | Rosydawn`}>
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="logo">
        <span class="prompt">$</span> rosydawn
        <span class="cursor">_</span>
      </a>
      <nav class="nav">
        <a href="/">blog</a>
        <a href="/tags">tags</a>
        <a href="/about">about</a>
      </nav>
    </div>
  </header>

  <main class="main-wrapper">
    <article class="article">
      <header class="article-header">
        <a href="/" class="back-link">
          <span class="back-arrow">←</span>
          <span>cd ..</span>
        </a>

        <h1 class="title">{post.data.title}</h1>
        
        <div class="meta-line">
          <time datetime={post.data.date.toISOString()}>
            {formatDate(post.data.date)}
          </time>
          {post.data.tags && (
            <div class="tags">
              {post.data.tags.map((tag) => (
                <a href={`/tags/${tag}`} class="tag">#{tag}</a>
              ))}
            </div>
          )}
        </div>

        {post.data.description && (
          <p class="description">{post.data.description}</p>
        )}
      </header>

      <div class="content">
        <Content />
      </div>

      <footer class="article-footer">
        <a href="/" class="back-link">
          <span class="back-arrow">←</span>
          <span>返回文章列表</span>
        </a>
      </footer>
    </article>

    {tocHeadings.length > 0 && (
      <aside class="toc-sidebar">
        <nav class="toc">
          <h4 class="toc-title">目录</h4>
          <ul class="toc-list">
            {tocHeadings.map((heading) => (
              <li class={`toc-item toc-item-${heading.depth}`}>
                <a href={`#${heading.slug}`} class="toc-link">
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
  </main>

  <footer class="site-footer">
    <p>© 2026 rosydawn · built with astro</p>
  </footer>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 目录高亮
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('.content h2, .content h3');
    
    if (tocLinks.length > 0 && headings.length > 0) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute('id');
              tocLinks.forEach((link) => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${id}`) {
                  link.classList.add('active');
                }
              });
            }
          });
        },
        { rootMargin: '-80px 0px -80% 0px' }
      );
      headings.forEach((heading) => observer.observe(heading));
    }

    // 代码块复制功能
    document.querySelectorAll('.content pre').forEach((block) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';
      block.parentNode?.insertBefore(wrapper, block);
      wrapper.appendChild(block);

      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.setAttribute('aria-label', '复制代码');
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      wrapper.appendChild(btn);

      btn.addEventListener('click', async () => {
        const code = block.querySelector('code');
        if (code) {
          await navigator.clipboard.writeText(code.textContent || '');
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
          btn.classList.add('copied');
          setTimeout(() => {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
            btn.classList.remove('copied');
          }, 2000);
        }
      });
    });
  });
</script>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }

  .header-inner {
    max-width: 720px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    text-decoration: none;
  }

  .logo:hover { text-decoration: none; }
  .prompt { color: var(--accent); }
  .cursor { color: var(--accent); animation: blink 1s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  .nav {
    display: flex;
    gap: 2rem;
    font-family: var(--font-mono);
    font-size: 0.9rem;
  }

  .nav a {
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.2s;
  }

  .nav a:hover { color: var(--accent); }

  /* 主布局 */
  .main-wrapper {
    position: relative;
  }

  .article {
    max-width: 720px;
    margin: 0 auto;
    padding: 2.5rem 2rem;
  }

  .article-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: color 0.2s;
  }

  .back-link:hover { color: var(--accent); text-decoration: none; }
  .back-arrow { transition: transform 0.2s; }
  .back-link:hover .back-arrow { transform: translateX(-4px); }

  .title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 0.75rem 0;
    line-height: 1.3;
    letter-spacing: -0.02em;
  }

  .meta-line {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
  }

  .meta-line time { color: var(--text-muted); }
  .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .tag { color: var(--text-dim); text-decoration: none; transition: color 0.2s; }
  .tag:hover { color: var(--accent); text-decoration: none; }

  .description {
    font-size: 1rem;
    color: var(--text-muted);
    margin: 0;
    line-height: 1.6;
  }

  /* 目录侧边栏 */
  .toc-sidebar {
    position: fixed;
    top: 100px;
    left: calc(50% + 400px);
    width: 200px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }

  .toc {
    padding-left: 1rem;
    border-left: 1px solid var(--border);
  }

  .toc-title {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.75rem 0;
  }

  .toc-list { list-style: none; padding: 0; margin: 0; }
  .toc-item { margin: 0; }
  .toc-item-3 { padding-left: 0.75rem; }

  .toc-link {
    display: block;
    padding: 0.25rem 0;
    font-size: 0.75rem;
    color: var(--text-dim);
    text-decoration: none;
    line-height: 1.4;
    transition: all 0.2s;
    border-left: 2px solid transparent;
    margin-left: -1rem;
    padding-left: calc(1rem - 2px);
  }

  .toc-link:hover { color: var(--text); text-decoration: none; }
  .toc-link.active { color: var(--accent); border-left-color: var(--accent); }
  .toc-item-3 .toc-link { font-size: 0.7rem; padding-left: calc(1.75rem - 2px); }

  /* 文章内容 */
  .content {
    line-height: 1.7;
    color: var(--text);
    font-size: 0.925rem;
  }

  .content :global(h1:first-child) { display: none; }

  .content :global(h2) {
    font-size: 1.35rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    color: var(--text);
    padding-bottom: 0.35rem;
    border-bottom: 1px solid var(--border-light);
    scroll-margin-top: 80px;
  }

  .content :global(h3) {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 1.5rem 0 0.5rem;
    color: var(--text);
    scroll-margin-top: 80px;
  }

  .content :global(h4) {
    font-size: 1rem;
    font-weight: 600;
    margin: 1.25rem 0 0.5rem;
    color: var(--text);
  }

  .content :global(p) { margin: 1rem 0; }

  .content :global(ul),
  .content :global(ol) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .content :global(li) { margin: 0.35rem 0; }
  .content :global(li)::marker { color: var(--text-muted); }
  .content :global(strong) { color: var(--text); font-weight: 600; }

  .content :global(code) {
    background: var(--code-bg);
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
    font-size: 0.85em;
    font-family: var(--font-mono);
    color: var(--accent-dim);
    border: 1px solid var(--border-light);
  }

  /* 代码块 */
  .content :global(.code-wrapper) {
    position: relative;
    margin: 1.25rem 0;
  }

  .content :global(.code-wrapper pre) { margin: 0; }

  .content :global(.copy-btn) {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 4px;
    padding: 0.35rem;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
  }

  .content :global(.code-wrapper:hover .copy-btn) { opacity: 1; }
  .content :global(.copy-btn:hover) { background: rgba(255, 255, 255, 0.2); color: #fff; }
  .content :global(.copy-btn.copied) { color: #4ade80; }

  .content :global(pre) {
    background: #1a1a2e;
    padding: 1rem 1.25rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1.25rem 0;
    border: 1px solid var(--border);
  }

  .content :global(pre code) {
    background: transparent;
    padding: 0;
    color: #e1e4e8;
    font-size: 0.85rem;
    line-height: 1.6;
    border: none;
  }

  .content :global(blockquote) {
    border-left: 3px solid var(--accent);
    margin: 1.25rem 0;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 0 6px 6px 0;
    color: var(--text);
  }

  .content :global(blockquote p) { margin: 0; }
  .content :global(blockquote p + p) { margin-top: 0.5rem; }

  .content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.25rem 0;
    font-size: 0.875rem;
  }

  .content :global(th),
  .content :global(td) {
    border: 1px solid var(--border);
    padding: 0.5rem 0.75rem;
    text-align: left;
  }

  .content :global(th) {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text);
  }

  .content :global(tr:nth-child(even) td) { background: var(--bg-secondary); }

  .content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 1.25rem 0;
  }

  .content :global(figure) { margin: 1.25rem 0; }

  .content :global(a) {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid var(--accent-light);
    transition: all 0.2s;
  }

  .content :global(a:hover) { border-bottom-color: var(--accent); text-decoration: none; }

  .content :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
  }

  .article-footer { 
    margin-top: 2.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--border);
  }

  .site-footer {
    max-width: 720px;
    margin: 0 auto;
    padding: 1.25rem 2rem;
    border-top: 1px solid var(--border);
  }

  .site-footer p {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-dim);
    margin: 0;
  }

  @media (max-width: 1200px) {
    .toc-sidebar { display: none; }
  }

  @media (max-width: 640px) {
    .header-inner { padding: 1rem; }
    .article { padding: 1.5rem 1rem; }
    .site-header { position: relative; }
    .header-inner { flex-direction: column; gap: 1rem; align-items: flex-start; }
    .nav { gap: 1.5rem; }
    .title { font-size: 1.5rem; }
    .content { font-size: 0.95rem; }
    .content :global(h2) { font-size: 1.2rem; }
    .content :global(h3) { font-size: 1rem; }
    .content :global(pre) {
      padding: 0.875rem;
      font-size: 0.8rem;
      border-radius: 0;
      margin-left: -1rem;
      margin-right: -1rem;
      border-left: none;
      border-right: none;
    }
    .content :global(.code-wrapper) { margin-left: -1rem; margin-right: -1rem; }
    .content :global(.copy-btn) { opacity: 1; }
    .site-footer { padding: 1.25rem 1rem; }
  }
</style>
