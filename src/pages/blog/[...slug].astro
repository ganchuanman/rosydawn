---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BackToTop from '../../components/BackToTop.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const sortedPosts = posts.sort((a, b) =>
    new Date(a.data.date).getTime() - new Date(b.data.date).getTime()
  );
  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: index > 0 ? { id: sortedPosts[index - 1].id, title: sortedPosts[index - 1].data.title } : null,
      nextPost: index < sortedPosts.length - 1 ? { id: sortedPosts[index + 1].id, title: sortedPosts[index + 1].data.title } : null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

function formatDate(date: Date): string {
  return date.toISOString().split('T')[0];
}

// 过滤出 h2 和 h3 标题用于目录
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

// 计算预计阅读时间（400 字/分钟）
const bodyText = post.body || '';
const charCount = bodyText.replace(/\s+/g, '').length;
const readingTime = Math.max(1, Math.ceil(charCount / 400));
---

<Layout title={`${post.data.title} | Rosydawn`}>
  <div class="reading-progress" id="reading-progress"></div>
  <div class="page-container">
    <Header currentPath="/blog" />

  <main class="main-wrapper">
    <article class="article">
      <header class="article-header">
        <a href="/" class="back-link" onclick="event.preventDefault(); history.back();">
          <span class="back-arrow">←</span>
          <span>返回</span>
        </a>

        <h1 class="title">{post.data.title}</h1>
        
        <div class="meta-line">
          <time datetime={post.data.date.toISOString()}>
            {formatDate(post.data.date)}
          </time>
          <span class="reading-time">· {readingTime} 分钟</span>
          {post.data.tags && (
            <div class="tags">
              {post.data.tags.map((tag) => (
                <a href={`/tags/${tag}`} class="tag">#{tag}</a>
              ))}
            </div>
          )}
        </div>

        {post.data.description && (
          <p class="description">{post.data.description}</p>
        )}
      </header>

      <div class="content">
        <Content />
      </div>

      <footer class="article-footer">
        <a href="/" class="back-link" onclick="event.preventDefault(); history.back();">
          <span class="back-arrow">←</span>
          <span>返回</span>
        </a>

        {(prevPost || nextPost) && (
          <nav class="post-nav">
            <div class="post-nav-item post-nav-prev">
              {prevPost && (
                <a href={`/blog/${prevPost.id}`}>
                  <span class="post-nav-label">← 上一篇</span>
                  <span class="post-nav-title">{prevPost.title}</span>
                </a>
              )}
            </div>
            <div class="post-nav-item post-nav-next">
              {nextPost && (
                <a href={`/blog/${nextPost.id}`}>
                  <span class="post-nav-label">下一篇 →</span>
                  <span class="post-nav-title">{nextPost.title}</span>
                </a>
              )}
            </div>
          </nav>
        )}
      </footer>
    </article>

    {tocHeadings.length > 0 && (
      <aside class="toc-sidebar">
        <nav class="toc">
          <h4 class="toc-title">目录</h4>
          <ul class="toc-list">
            {tocHeadings.map((heading) => (
              <li class={`toc-item toc-item-${heading.depth}`}>
                <a href={`#${heading.slug}`} class="toc-link">
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
  </main>

    <Footer />
    <BackToTop />
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    // 阅读进度条
    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      window.addEventListener('scroll', () => {
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
        progressBar.style.width = progress + '%';
      });
    }

    // 目录高亮
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('.content h2, .content h3');
    
    if (tocLinks.length > 0 && headings.length > 0) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute('id');
              tocLinks.forEach((link) => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${id}`) {
                  link.classList.add('active');
                }
              });
            }
          });
        },
        { rootMargin: '-80px 0px -80% 0px' }
      );
      headings.forEach((heading) => observer.observe(heading));
    }

    // 代码块复制功能、语言标签、行号和展开收起
    const COLLAPSED_MAX_LINES = 15; // 超过这个行数时显示展开/收起按钮

    document.querySelectorAll('.content pre').forEach((block, index) => {
      const pre = block as HTMLPreElement;
      const wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // 获取语言类型 - 从 pre 标签的 data-language 属性获取
      const lang = pre.getAttribute('data-language') || 'text';
      const code = pre.querySelector('code');

      // 创建顶部工具栏
      const toolbar = document.createElement('div');
      toolbar.className = 'code-toolbar';
      
      // 左侧容器（展开按钮 + 语言标签）
      const leftGroup = document.createElement('div');
      leftGroup.className = 'code-left-group';

      // 语言标签
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = lang.toLowerCase();

      // 右侧按钮组
      const btnGroup = document.createElement('div');
      btnGroup.className = 'code-btn-group';

      // 复制按钮
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.setAttribute('aria-label', '复制代码');
      copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>复制</span>';
      btnGroup.appendChild(copyBtn);
      
      toolbar.appendChild(leftGroup);
      toolbar.appendChild(btnGroup);
      wrapper.insertBefore(toolbar, pre);

      // 添加行号 - Shiki 已经用 span.line 包裹每行
      if (code) {
        // 移除 span.line 之间的空白文本节点
        Array.from(code.childNodes).forEach(node => {
          if (node.nodeType === Node.TEXT_NODE) {
            node.remove();
          }
        });

        const lines = code.querySelectorAll(':scope > .line');
        const lineCount = lines.length;
        
        lines.forEach((line, i) => {
          const lineNum = document.createElement('span');
          lineNum.className = 'line-number';
          lineNum.textContent = String(i + 1);
          line.insertBefore(lineNum, line.firstChild);
        });
        code.classList.add('has-line-numbers');

        // 根据最大行号计算宽度，保证所有行号等宽
        const maxLineDigits = String(lineCount).length;
        code.style.setProperty('--line-number-width', `${maxLineDigits}ch`);

        // 展开/收起功能
        if (lineCount > COLLAPSED_MAX_LINES) {
          wrapper.classList.add('collapsible');
          wrapper.classList.add('collapsed');
          
          // 创建渐变遮罩
          const fadeOverlay = document.createElement('div');
          fadeOverlay.className = 'code-fade-overlay';
          wrapper.appendChild(fadeOverlay);
          
          // 创建展开/收起按钮（放在工具栏左侧）
          const expandBtn = document.createElement('button');
          expandBtn.className = 'expand-btn';
          expandBtn.innerHTML = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg><span>${lineCount} 行</span>`;
          leftGroup.appendChild(expandBtn);
          leftGroup.appendChild(langLabel);
          
          expandBtn.addEventListener('click', () => {
            const isCollapsed = wrapper.classList.contains('collapsed');
            
            // 记录切换前 wrapper 顶部相对于视口的位置
            const rectBefore = wrapper.getBoundingClientRect();
            const topBefore = rectBefore.top;
            
            if (isCollapsed) {
              wrapper.classList.remove('collapsed');
            } else {
              wrapper.classList.add('collapsed');
            }
            
            // 切换后，补偿滚动偏移以保持 wrapper 位置不变
            const rectAfter = wrapper.getBoundingClientRect();
            const topAfter = rectAfter.top;
            const scrollDiff = topAfter - topBefore;
            
            if (scrollDiff !== 0) {
              window.scrollBy(0, scrollDiff);
            }
          });
        } else {
          // 不需要展开收起时，只添加语言标签
          leftGroup.appendChild(langLabel);
        }
      }

      copyBtn.addEventListener('click', async () => {
        // 获取纯代码文本（排除行号）
        const lines = code?.querySelectorAll(':scope > .line');
        let textContent = '';
        lines?.forEach(line => {
          const lineContent = Array.from(line.childNodes)
            .filter(node => !(node as Element).classList?.contains('line-number'))
            .map(node => node.textContent)
            .join('');
          textContent += lineContent + '\n';
        });
        textContent = textContent.trimEnd();
        
        await navigator.clipboard.writeText(textContent);
        copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>已复制</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>复制</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      });
    });
  });
</script>

<style>
  .reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--accent);
    z-index: 9999;
    transition: none;
  }

  .page-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* 主布局 */
  .main-wrapper {
    position: relative;
  }

  .main-wrapper {
    flex: 1;
  }

  .article {
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  .article-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: color 0.2s;
  }

  .back-link:hover { color: var(--accent); text-decoration: none; }
  .back-arrow { transition: transform 0.2s; }
  .back-link:hover .back-arrow { transform: translateX(-4px); }

  .title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 0.75rem 0;
    line-height: 1.3;
    letter-spacing: -0.02em;
  }

  .meta-line {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
  }

  .meta-line time { color: var(--text-muted); }
  .reading-time { color: var(--text-muted); }
  .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .tag { color: var(--text-dim); text-decoration: none; transition: color 0.2s; }
  .tag:hover { color: var(--accent); text-decoration: none; }

  .description {
    font-size: 1rem;
    color: var(--text-muted);
    margin: 0;
    line-height: 1.6;
  }

  /* 目录侧边栏 */
  .toc-sidebar {
    position: fixed;
    top: 100px;
    left: calc(50% + 400px);
    width: 200px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }

  .toc {
    padding-left: 1rem;
    border-left: 1px solid var(--border);
  }

  .toc-title {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.75rem 0;
  }

  .toc-list { list-style: none; padding: 0; margin: 0; }
  .toc-item { margin: 0; }
  .toc-item-3 { padding-left: 0.75rem; }

  .toc-link {
    display: block;
    padding: 0.25rem 0;
    font-size: 0.75rem;
    color: var(--text-dim);
    text-decoration: none;
    line-height: 1.4;
    transition: all 0.2s;
    border-left: 2px solid transparent;
    margin-left: -1rem;
    padding-left: calc(1rem - 2px);
  }

  .toc-link:hover { color: var(--text); text-decoration: none; }
  .toc-link.active { color: var(--accent); border-left-color: var(--accent); }
  .toc-item-3 .toc-link { font-size: 0.7rem; padding-left: calc(1.75rem - 2px); }

  /* 文章内容 */
  .content {
    line-height: 1.7;
    color: var(--text);
    font-size: 0.925rem;
  }

  .content :global(h1:first-child) { display: none; }

  .content :global(h2) {
    font-size: 1.35rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    color: var(--text);
    padding-bottom: 0.35rem;
    border-bottom: 1px solid var(--border-light);
    scroll-margin-top: 80px;
  }

  .content :global(h3) {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 1.5rem 0 0.5rem;
    color: var(--text);
    scroll-margin-top: 80px;
  }

  .content :global(h4) {
    font-size: 1rem;
    font-weight: 600;
    margin: 1.25rem 0 0.5rem;
    color: var(--text);
  }

  .content :global(p) { margin: 1rem 0; }

  .content :global(ul),
  .content :global(ol) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .content :global(li) { margin: 0.35rem 0; }
  .content :global(li)::marker { color: var(--text-muted); }
  .content :global(strong) { color: var(--text); font-weight: 600; }

  .content :global(code) {
    background: var(--code-bg);
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
    font-size: 0.85em;
    font-family: var(--font-mono);
    color: var(--accent-dim);
    border: 1px solid var(--border-light);
  }

  /* 代码块 */
  .content :global(.code-wrapper) {
    position: relative;
    margin: 1.25rem 0;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  .content :global(.code-toolbar) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0.75rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .content :global(.code-lang) {
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }

  .content :global(.copy-btn) {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: transparent;
    border: none;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .content :global(.copy-btn:hover) { 
    background: var(--bg-tertiary);
    color: var(--text);
  }

  .content :global(.copy-btn.copied) { color: #16a34a; }

  .content :global(.code-wrapper pre) { 
    margin: 0;
    border: none;
    border-radius: 0;
  }

  .content :global(pre) {
    background: var(--code-bg);
    padding: 1rem 1.25rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1.25rem 0;
    border: 1px solid var(--border);
  }

  .content :global(pre code) {
    background: transparent;
    padding: 0;
    color: var(--text);
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace !important;
    font-size: 13px !important;
    line-height: 1.5 !important;
    border: none;
    display: flex;
    flex-direction: column;
  }

  .content :global(pre code *) {
    font-family: inherit !important;
    line-height: inherit !important;
  }

  .content :global(pre code.has-line-numbers) {
    display: flex;
    flex-direction: column;
  }

  /* Shiki 生成的行样式 */
  .content :global(pre code .line) {
    display: block;
    padding: 0;
    margin: 0;
    height: 1.5em;
  }

  .content :global(.line-number) {
    display: inline-block;
    width: var(--line-number-width, 2ch);
    margin-right: 1em;
    text-align: right;
    color: var(--text-dim);
    user-select: none;
    opacity: 0.4;
    font-size: inherit;
    flex-shrink: 0;
  }

  /* 左侧容器和按钮组 */
  .content :global(.code-left-group) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .content :global(.code-btn-group) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* 工具栏内的展开按钮 */
  .content :global(.code-left-group .expand-btn) {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: transparent;
    border: none;
    padding: 0.15rem 0.4rem;
    cursor: pointer;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    border-radius: 3px;
    transition: all 0.2s;
  }

  .content :global(.code-left-group .expand-btn:hover) {
    background: var(--bg-tertiary);
    color: var(--text);
  }

  .content :global(.code-left-group .expand-btn svg) {
    transition: transform 0.2s;
  }

  .content :global(.code-wrapper:not(.collapsed) .code-left-group .expand-btn svg) {
    transform: rotate(180deg);
  }

  /* 展开收起功能 */
  .content :global(.code-wrapper.collapsible.collapsed pre) {
    max-height: 312px !important; /* 约15行: 15 * 19.5px (13px * 1.5) + 20px padding */
    overflow: hidden !important;
  }

  .content :global(.code-wrapper.collapsible:not(.collapsed) pre) {
    max-height: none !important;
  }

  .content :global(.code-wrapper.collapsed .code-fade-overlay) {
    display: block;
  }

  .content :global(.code-fade-overlay) {
    display: none;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(to bottom, transparent, var(--code-bg));
    pointer-events: none;
    z-index: 5;
  }

  .content :global(blockquote) {
    border-left: 3px solid var(--accent);
    margin: 1.25rem 0;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 0 6px 6px 0;
    color: var(--text);
  }

  .content :global(blockquote p) { margin: 0; }
  .content :global(blockquote p + p) { margin-top: 0.5rem; }

  .content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.25rem 0;
    font-size: 0.875rem;
  }

  .content :global(th),
  .content :global(td) {
    border: 1px solid var(--border);
    padding: 0.5rem 0.75rem;
    text-align: left;
  }

  .content :global(th) {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text);
  }

  .content :global(tr:nth-child(even) td) { background: var(--bg-secondary); }

  .content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 1.25rem 0;
  }

  .content :global(figure) { margin: 1.25rem 0; }

  .content :global(a) {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid var(--accent-light);
    transition: all 0.2s;
  }

  .content :global(a:hover) { border-bottom-color: var(--accent); text-decoration: none; }

  .content :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
  }

  .article-footer {
    margin-top: 2.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--border);
  }

  /* 上/下篇导航 */
  .post-nav {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .post-nav-item {
    flex: 1;
    min-width: 0;
  }

  .post-nav-next {
    text-align: right;
  }

  .post-nav-item a {
    display: block;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    text-decoration: none;
    transition: border-color 0.2s;
  }

  .post-nav-item a:hover {
    border-color: var(--accent);
    text-decoration: none;
  }

  .post-nav-label {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
  }

  .post-nav-title {
    display: block;
    font-size: 0.875rem;
    color: var(--text);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 0.2s;
  }

  .post-nav-item a:hover .post-nav-title {
    color: var(--accent);
  }

  @media (max-width: 1200px) {
    .toc-sidebar { display: none; }
  }

  @media (max-width: 640px) {
    .page-container { padding: 1rem; }
    .title { font-size: 1.5rem; }
    .content { font-size: 0.95rem; }
    .content :global(h2) { font-size: 1.2rem; }
    .content :global(h3) { font-size: 1rem; }
    .content :global(pre) {
      padding: 0.875rem;
      font-size: 0.8rem;
    }
    .content :global(.code-wrapper) {
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
    .post-nav { flex-direction: column; }
    .post-nav-next { text-align: left; }
  }
</style>
