---
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title?: string;
}

const { title = 'Rosydawn' } = Astro.props;
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content="记录技术思考与实践的个人博客" />
		<title>{title}</title>
		<ViewTransitions />
		<script is:inline>
			(function() {
				function applyTheme() {
					try {
						var theme = localStorage.getItem('theme');
						if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
							document.documentElement.setAttribute('data-theme', 'dark');
						} else {
							document.documentElement.removeAttribute('data-theme');
						}
					} catch (e) {}
				}
				applyTheme();
				document.addEventListener('astro:after-swap', applyTheme);
			})();
		</script>
	</head>
	<body>
		<slot />
		<script is:inline>
			(function() {
				function updateToggleIcon(btn) {
					if (!btn) return;
					var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
					btn.innerHTML = isDark
						? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
						: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
					btn.setAttribute('aria-label', isDark ? '切换浅色模式' : '切换暗色模式');
				}
				document.addEventListener('astro:page-load', function() {
					var btn = document.querySelector('.theme-toggle');
					if (!btn) return;
					updateToggleIcon(btn);
					btn.addEventListener('click', function() {
						var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
						if (isDark) {
							document.documentElement.removeAttribute('data-theme');
							try { localStorage.setItem('theme', 'light'); } catch (e) {}
						} else {
							document.documentElement.setAttribute('data-theme', 'dark');
							try { localStorage.setItem('theme', 'dark'); } catch (e) {}
						}
						updateToggleIcon(btn);
					});
				});
			})();
		</script>
		<script is:inline>
			// PlantUML image/source toggle functionality
			(function() {
				// Use event delegation to handle both static and dynamically created buttons
				document.addEventListener('click', function(e) {
					// Handle "toggle to code" buttons on images
					if (e.target.closest('.plantuml-toggle-to-code')) {
						var container = e.target.closest('.plantuml-container');
						if (container) {
							container.setAttribute('data-state', 'code');
						}
					}

					// Handle "toggle to image" buttons in code toolbar (added by slug.astro script)
					if (e.target.closest('.plantuml-toggle-to-image')) {
						var container = e.target.closest('.plantuml-container');
						if (container) {
							container.setAttribute('data-state', 'image');
						}
					}
				});

				// Event delegation handles both static and dynamically created buttons
				// No need to reinitialize after View Transitions
			})();
		</script>
	</body>
</html>

<style is:global>
	:root {
		--bg: #fafafa;
		--bg-secondary: #f0f0f0;
		--bg-tertiary: #e8e8e8;
		--text: #1a1a1a;
		--text-muted: #666666;
		--text-dim: #999999;
		--accent: #0969da;
		--accent-dim: #0550ae;
		--accent-light: #ddf4ff;
		--border: #d0d7de;
		--border-light: #e1e4e8;
		--code-bg: #f6f8fa;
		/* 使用系统等宽字体，零网络请求，首屏秒开 */
		--font-mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
		--font-sans: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
	}

	html[data-theme="dark"] {
		--bg: #0d1117;
		--bg-secondary: #161b22;
		--bg-tertiary: #21262d;
		--text: #e6edf3;
		--text-muted: #8b949e;
		--text-dim: #6e7681;
		--accent: #58a6ff;
		--accent-dim: #79c0ff;
		--accent-light: #1f3a5f;
		--border: #30363d;
		--border-light: #21262d;
		--code-bg: #161b22;
	}

	*, *::before, *::after {
		box-sizing: border-box;
	}

	html {
		font-family: var(--font-sans);
		background: var(--bg);
		color: var(--text);
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
	}

	html, body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100vh;
	}

	::selection {
		background: var(--accent);
		color: white;
	}

	/* Scrollbar styling */
	::-webkit-scrollbar {
		width: 8px;
		height: 8px;
	}

	::-webkit-scrollbar-track {
		background: var(--bg);
	}

	::-webkit-scrollbar-thumb {
		background: var(--border);
		border-radius: 4px;
	}

	::-webkit-scrollbar-thumb:hover {
		background: var(--text-muted);
	}

	/* Links */
	a {
		color: var(--accent);
		text-decoration: none;
	}

	a:hover {
		text-decoration: underline;
	}

	/* Code */
	code {
		font-family: var(--font-mono);
	}

	/* Diagram Styles */
	.diagram {
		margin: 0.5rem 0;
		text-align: center;
	}

	.diagram img {
		max-width: 100%;
		height: auto;
		border-radius: 8px;
		background: white;
		padding: 1rem;
		border: 1px solid var(--border);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
	}

	.diagram iframe {
		max-width: 100%;
	}

	/* PlantUML Container Styles */
	.plantuml-container {
		margin: 1.25rem 0;
	}

	.plantuml-image-wrapper {
		position: relative;
		text-align: center;
	}

	/* Toggle button floating on image */
	.plantuml-toggle-to-code {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 28px;
		height: 28px;
		padding: 0;
		color: var(--text-muted);
		background: var(--bg);
		border: 1px solid var(--border);
		border-radius: 4px;
		cursor: pointer;
		transition: all 0.2s;
		opacity: 0;
		z-index: 10;
	}

	.plantuml-image-wrapper:hover .plantuml-toggle-to-code {
		opacity: 0.8;
	}

	.plantuml-toggle-to-code:hover {
		color: var(--accent);
		border-color: var(--accent);
		opacity: 1 !important;
	}

	/* Image styles - no border, clean look */
	.plantuml-image {
		display: inline-block;
		max-width: 100%;
		height: auto;
		background: white;
		border-radius: 4px;
	}

	/* PlantUML code block - hidden by default */
	.plantuml-code-placeholder {
		display: none;
	}

	/* State-based visibility */
	.plantuml-container[data-state="image"] .plantuml-image-wrapper {
		display: block;
	}

	.plantuml-container[data-state="image"] .plantuml-code-wrapper {
		display: none !important;
	}

	.plantuml-container[data-state="code"] .plantuml-image-wrapper {
		display: none;
	}

	.plantuml-container[data-state="code"] .plantuml-code-wrapper {
		display: block !important;
	}

	/* Dark mode: ensure image has white background */
	html[data-theme="dark"] .plantuml-image {
		background: white;
	}

	/* Toggle to image button in code toolbar */
	.plantuml-toggle-to-image {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		background: transparent;
		border: none;
		padding: 0.25rem 0.5rem;
		cursor: pointer;
		color: var(--text-muted);
		font-family: var(--font-mono);
		font-size: 0.7rem;
		border-radius: 4px;
		transition: all 0.2s;
	}

	.plantuml-toggle-to-image:hover {
		background: var(--bg-tertiary);
		color: var(--text);
	}

	.drawio-placeholder {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 1rem;
		padding: 2rem;
		background: var(--bg-secondary);
		border: 2px dashed var(--border);
		border-radius: 8px;
		color: var(--text-muted);
	}

	.drawio-placeholder svg {
		opacity: 0.5;
	}

	.drawio-filename,
	.drawio-desc {
		font-family: var(--font-mono);
		font-size: 0.9rem;
		margin: 0;
		color: var(--text-muted);
	}

	.drawio-open-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		font-family: var(--font-mono);
		font-size: 0.85rem;
		color: var(--accent);
		background: var(--bg);
		border: 1px solid var(--accent);
		border-radius: 6px;
		text-decoration: none;
		transition: all 0.2s;
	}

	.drawio-open-btn:hover {
		background: var(--accent);
		color: white;
		text-decoration: none;
	}

	/* Theme toggle */
	.theme-toggle {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		background: transparent;
		border: 1px solid var(--border);
		border-radius: 6px;
		cursor: pointer;
		color: var(--text-muted);
		transition: all 0.2s;
		flex-shrink: 0;
	}

	.theme-toggle:hover {
		color: var(--accent);
		border-color: var(--accent);
	}

	/* Shiki dual theme: activate dark colors when data-theme="dark" */
	html[data-theme="dark"] .astro-code,
	html[data-theme="dark"] .astro-code span {
		color: var(--shiki-dark) !important;
		background-color: var(--shiki-dark-bg) !important;
	}
</style>