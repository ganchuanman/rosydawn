---
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title?: string;
}

const { title = 'Rosydawn' } = Astro.props;
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content="记录技术思考与实践的个人博客" />
		<title>{title}</title>
		<ViewTransitions />
		<script is:inline>
			(function() {
				function applyTheme() {
					try {
						var theme = localStorage.getItem('theme');
						if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
							document.documentElement.setAttribute('data-theme', 'dark');
						} else {
							document.documentElement.removeAttribute('data-theme');
						}
					} catch (e) {}
				}
				applyTheme();
				document.addEventListener('astro:after-swap', applyTheme);
			})();
		</script>
	</head>
	<body>
		<slot />
		<script is:inline>
			(function() {
				function updateToggleIcon(btn) {
					if (!btn) return;
					var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
					btn.innerHTML = isDark
						? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
						: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
					btn.setAttribute('aria-label', isDark ? '切换浅色模式' : '切换暗色模式');
				}
				document.addEventListener('astro:page-load', function() {
					var btn = document.querySelector('.theme-toggle');
					if (!btn) return;
					updateToggleIcon(btn);
					btn.addEventListener('click', function() {
						var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
						if (isDark) {
							document.documentElement.removeAttribute('data-theme');
							try { localStorage.setItem('theme', 'light'); } catch (e) {}
						} else {
							document.documentElement.setAttribute('data-theme', 'dark');
							try { localStorage.setItem('theme', 'dark'); } catch (e) {}
						}
						updateToggleIcon(btn);
					});
				});
			})();
		</script>
		<script is:inline>
			// PlantUML image/source toggle functionality
			(function() {
				// Function to create code block if it doesn't exist
				function ensureCodeBlockExists(container) {
					var placeholder = container.querySelector('.plantuml-code-placeholder');
					var existingWrapper = container.querySelector('.plantuml-code-wrapper');

					// If wrapper already exists, no need to create it
					if (existingWrapper) return true;

					// If no placeholder, can't create code block
					if (!placeholder) return false;

					var base64Source = container.getAttribute('data-plantuml-source');
					if (!base64Source) return false;

					try {
						// Decode the base64 source code with proper UTF-8 handling
						var binaryString = atob(base64Source);
						var bytes = new Uint8Array(binaryString.length);
						for (var i = 0; i < binaryString.length; i++) {
							bytes[i] = binaryString.charCodeAt(i);
						}
						var sourceCode = new TextDecoder('utf-8').decode(bytes);

						// Create wrapper
						var wrapper = document.createElement('div');
						wrapper.className = 'code-wrapper plantuml-code-wrapper';

						// Create toolbar
						var toolbar = document.createElement('div');
						toolbar.className = 'code-toolbar';

						var leftGroup = document.createElement('div');
						leftGroup.className = 'code-left-group';

						var langLabel = document.createElement('span');
						langLabel.className = 'code-lang';
						langLabel.textContent = 'plantuml';
						leftGroup.appendChild(langLabel);

						var btnGroup = document.createElement('div');
						btnGroup.className = 'code-btn-group';

						// Add "show image" button
						var imageBtn = document.createElement('button');
						imageBtn.className = 'plantuml-toggle-to-image';
						imageBtn.setAttribute('aria-label', '显示图片');
						imageBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><span>图片</span>';
						btnGroup.appendChild(imageBtn);

						// Add copy button
						var copyBtn = document.createElement('button');
						copyBtn.className = 'copy-btn';
						copyBtn.setAttribute('aria-label', '复制代码');
						copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>复制</span>';
						btnGroup.appendChild(copyBtn);

						toolbar.appendChild(leftGroup);
						toolbar.appendChild(btnGroup);

						// Create pre/code structure
						var pre = document.createElement('pre');
						pre.style.cssText = 'background-color:var(--code-bg);color:var(--text);overflow-x:auto';
						pre.tabIndex = 0;

						var code = document.createElement('code');
						code.className = 'has-line-numbers';

						// Split into lines and add line numbers
						var lines = sourceCode.split('\n');
						var maxLineDigits = String(lines.length).length;
						code.style.setProperty('--line-number-width', maxLineDigits + 'ch');

						lines.forEach(function(lineText, i) {
							var lineSpan = document.createElement('span');
							lineSpan.className = 'line';

							var lineNum = document.createElement('span');
							lineNum.className = 'line-number';
							lineNum.textContent = String(i + 1);

							var lineContent = document.createElement('span');
							lineContent.textContent = lineText;

							lineSpan.appendChild(lineNum);
							lineSpan.appendChild(lineContent);
							code.appendChild(lineSpan);
						});

						pre.appendChild(code);
						wrapper.appendChild(toolbar);
						wrapper.appendChild(pre);

						// Replace placeholder with wrapper
						placeholder.replaceWith(wrapper);

						// Setup copy functionality
						copyBtn.addEventListener('click', async function() {
							await navigator.clipboard.writeText(sourceCode);
							copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>已复制</span>';
							copyBtn.classList.add('copied');
							setTimeout(function() {
								copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>复制</span>';
								copyBtn.classList.remove('copied');
							}, 2000);
						});

						return true;
					} catch (err) {
						console.error('Failed to create code block:', err);
						return false;
					}
				}

				// Use event delegation to handle both static and dynamically created buttons
				document.addEventListener('click', function(e) {
					// Handle "toggle to code" buttons on images
					if (e.target.closest('.plantuml-toggle-to-code')) {
						var container = e.target.closest('.plantuml-container');
						if (container) {
							// Ensure code block exists before switching
							if (ensureCodeBlockExists(container)) {
								container.setAttribute('data-state', 'code');
							}
						}
					}

					// Handle "toggle to image" buttons in code toolbar (added by slug.astro script)
					if (e.target.closest('.plantuml-toggle-to-image')) {
						var container = e.target.closest('.plantuml-container');
						if (container) {
							container.setAttribute('data-state', 'image');
						}
					}
				});

				// Event delegation handles both static and dynamically created buttons
				// No need to reinitialize after View Transitions
			})();
		</script>
		<script is:inline>
			// PlantUML loading states management
			(function() {
				var TIMEOUT_MS = 30000; // 30 seconds timeout
				var DEBOUNCE_MS = 2000; // 2 seconds debounce

				function initPlantUMLLoading(container) {
					if (!container || container.dataset.loadingInitialized === 'true') {
						return;
					}

					var img = container.querySelector('.plantuml-image');
					if (!img || !img.src) {
						return;
					}

					// Store the base URL (without cache-busting parameter) for retry
					if (!container.dataset.baseUrl) {
						var urlParts = img.src.split('?');
						container.dataset.baseUrl = urlParts[0];
					}

					container.dataset.loadingInitialized = 'true';

					var timeoutId = null;
					var imgLoader = new Image();
					var isCleanedUp = false;

					function setState(state) {
						if (isCleanedUp) return;
						container.classList.remove('plantuml-loading', 'plantuml-error', 'plantuml-loaded');
						container.classList.add('plantuml-' + state);
					}

					function clearTimeouts() {
						if (timeoutId) {
							clearTimeout(timeoutId);
							timeoutId = null;
						}
					}

					function handleLoadSuccess() {
						if (isCleanedUp) return;
						clearTimeouts();
						setState('loaded');
						// Update the visible img src to match the loaded image
						img.src = imgLoader.src;
					}

					function handleLoadError() {
						if (isCleanedUp) return;
						clearTimeouts();
						setState('error');
					}

					// Set up timeout
					timeoutId = setTimeout(function() {
						handleLoadError();
					}, TIMEOUT_MS);

					// Load the image with fresh cache-busting parameter
					imgLoader.onload = handleLoadSuccess;
					imgLoader.onerror = handleLoadError;
					var cacheBuster = 't=' + Date.now();
					imgLoader.src = container.dataset.baseUrl + '?' + cacheBuster;

					// Store cleanup function
					container._cleanupLoading = function() {
						isCleanedUp = true;
						clearTimeouts();
						imgLoader.onload = null;
						imgLoader.onerror = null;
					};
				}

				function initAllPlantUMLContainers() {
					var containers = document.querySelectorAll('.plantuml-container.plantuml-loading');
					for (var i = 0; i < containers.length; i++) {
						initPlantUMLLoading(containers[i]);
					}
				}

				// Handle retry button clicks
				document.addEventListener('click', function(e) {
					var retryBtn = e.target.closest('.plantuml-retry-btn');
					if (!retryBtn) return;

					if (retryBtn.disabled) return;

					var container = retryBtn.closest('.plantuml-container');
					if (!container) return;

					// Disable button for debounce period
					retryBtn.disabled = true;
					setTimeout(function() {
						retryBtn.disabled = false;
					}, DEBOUNCE_MS);

					// Clean up previous loading
					if (container._cleanupLoading) {
						container._cleanupLoading();
						delete container._cleanupLoading;
					}

					// Reset to loading state
					container.dataset.loadingInitialized = 'false';
					container.classList.remove('plantuml-error', 'plantuml-loaded');
					container.classList.add('plantuml-loading');

					// Reinitialize
					initPlantUMLLoading(container);
				});

				// Initialize on page load
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initAllPlantUMLContainers);
				} else {
					initAllPlantUMLContainers();
				}

				// Reinitialize after View Transitions
				document.addEventListener('astro:page-load', initAllPlantUMLContainers);

				// Clean up when navigating away
				document.addEventListener('astro:before-preparation', function() {
					var containers = document.querySelectorAll('.plantuml-container');
					for (var i = 0; i < containers.length; i++) {
						if (containers[i]._cleanupLoading) {
							containers[i]._cleanupLoading();
						}
					}
				});
			})();
		</script>
	</body>
</html>

<style is:global>
	:root {
		--bg: #fafafa;
		--bg-secondary: #f0f0f0;
		--bg-tertiary: #e8e8e8;
		--text: #1a1a1a;
		--text-muted: #666666;
		--text-dim: #999999;
		--accent: #0969da;
		--accent-dim: #0550ae;
		--accent-light: #ddf4ff;
		--border: #d0d7de;
		--border-light: #e1e4e8;
		--code-bg: #f6f8fa;
		/* 使用系统等宽字体，零网络请求，首屏秒开 */
		--font-mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
		--font-sans: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
	}

	html[data-theme="dark"] {
		--bg: #0d1117;
		--bg-secondary: #161b22;
		--bg-tertiary: #21262d;
		--text: #e6edf3;
		--text-muted: #8b949e;
		--text-dim: #6e7681;
		--accent: #58a6ff;
		--accent-dim: #79c0ff;
		--accent-light: #1f3a5f;
		--border: #30363d;
		--border-light: #21262d;
		--code-bg: #161b22;
	}

	*, *::before, *::after {
		box-sizing: border-box;
	}

	html {
		font-family: var(--font-sans);
		background: var(--bg);
		color: var(--text);
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
	}

	html, body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100vh;
	}

	::selection {
		background: var(--accent);
		color: white;
	}

	/* Scrollbar styling */
	::-webkit-scrollbar {
		width: 8px;
		height: 8px;
	}

	::-webkit-scrollbar-track {
		background: var(--bg);
	}

	::-webkit-scrollbar-thumb {
		background: var(--border);
		border-radius: 4px;
	}

	::-webkit-scrollbar-thumb:hover {
		background: var(--text-muted);
	}

	/* Links */
	a {
		color: var(--accent);
		text-decoration: none;
	}

	a:hover {
		text-decoration: underline;
	}

	/* Code */
	code {
		font-family: var(--font-mono);
	}

	/* Diagram Styles */
	.diagram {
		margin: 0.5rem 0;
		text-align: center;
	}

	.diagram img {
		max-width: 100%;
		height: auto;
		border-radius: 8px;
		background: white;
		padding: 1rem;
		border: 1px solid var(--border);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
	}

	.diagram iframe {
		max-width: 100%;
	}

	/* PlantUML Container Styles */
	.plantuml-container {
		margin: 1.25rem 0;
	}

	.plantuml-image-wrapper {
		position: relative;
		text-align: center;
		min-height: 200px;
	}

	/* Toggle button floating on image */
	.plantuml-toggle-to-code {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 28px;
		height: 28px;
		padding: 0;
		color: var(--text-muted);
		background: var(--bg);
		border: 1px solid var(--border);
		border-radius: 4px;
		cursor: pointer;
		transition: all 0.2s;
		opacity: 0;
		z-index: 10;
	}

	.plantuml-image-wrapper:hover .plantuml-toggle-to-code {
		opacity: 0.8;
	}

	.plantuml-toggle-to-code:hover {
		color: var(--accent);
		border-color: var(--accent);
		opacity: 1 !important;
	}

	/* Image styles - no border, clean look */
	.plantuml-image {
		display: none;
		max-width: 100%;
		height: auto;
		background: white;
		border-radius: 4px;
	}

	/* PlantUML code block - hidden by default */
	.plantuml-code-placeholder {
		display: none;
	}

	/* PlantUML Loading State Container */
	.plantuml-loading-container,
	.plantuml-error-container {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		display: none;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 1rem;
		background: var(--bg);
		z-index: 5;
	}

	/* PlantUML Spinner Animation */
	.plantuml-spinner {
		width: 40px;
		height: 40px;
		border: 3px solid var(--border);
		border-top-color: var(--accent);
		border-radius: 50%;
		animation: plantuml-spin 0.8s linear infinite;
	}

	@keyframes plantuml-spin {
		to {
			transform: rotate(360deg);
		}
	}

	/* PlantUML Error Elements */
	.plantuml-error-icon {
		color: var(--text-muted);
		opacity: 0.6;
	}

	.plantuml-error-text {
		font-family: var(--font-sans);
		font-size: 0.9rem;
		color: var(--text-muted);
		margin: 0;
	}

	.plantuml-retry-btn {
		padding: 0.5rem 1rem;
		font-family: var(--font-sans);
		font-size: 0.85rem;
		color: var(--accent);
		background: transparent;
		border: 1px solid var(--accent);
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s;
	}

	.plantuml-retry-btn:hover:not(:disabled) {
		background: var(--accent);
		color: white;
	}

	.plantuml-retry-btn:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	/* State-based visibility */
	.plantuml-loading .plantuml-loading-container {
		display: flex;
	}

	.plantuml-loading .plantuml-error-container {
		display: none;
	}

	.plantuml-error .plantuml-error-container {
		display: flex;
	}

	.plantuml-error .plantuml-loading-container {
		display: none;
	}

	.plantuml-loaded .plantuml-image {
		display: inline-block !important;
	}

	.plantuml-loaded .plantuml-loading-container,
	.plantuml-loaded .plantuml-error-container {
		display: none;
	}

	/* Dark mode adjustments */
	html[data-theme="dark"] .plantuml-spinner {
		border-color: var(--border);
		border-top-color: var(--accent);
	}

	html[data-theme="dark"] .plantuml-error-icon {
		color: var(--text-muted);
	}

	html[data-theme="dark"] .plantuml-error-text {
		color: var(--text-muted);
	}

	html[data-theme="dark"] .plantuml-retry-btn {
		color: var(--accent);
		border-color: var(--accent);
	}

	html[data-theme="dark"] .plantuml-retry-btn:hover:not(:disabled) {
		background: var(--accent);
		color: var(--bg);
	}

	/* State-based visibility */
	.plantuml-container[data-state="image"] .plantuml-image-wrapper {
		display: block;
	}

	.plantuml-container[data-state="image"] .plantuml-code-wrapper {
		display: none !important;
	}

	.plantuml-container[data-state="code"] .plantuml-image-wrapper {
		display: none;
	}

	.plantuml-container[data-state="code"] .plantuml-code-wrapper {
		display: block !important;
	}

	/* Dark mode: ensure image has white background */
	html[data-theme="dark"] .plantuml-image {
		background: white;
	}

	/* Toggle to image button in code toolbar */
	.plantuml-toggle-to-image {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		background: transparent;
		border: none;
		padding: 0.25rem 0.5rem;
		cursor: pointer;
		color: var(--text-muted);
		font-family: var(--font-mono);
		font-size: 0.7rem;
		border-radius: 4px;
		transition: all 0.2s;
	}

	.plantuml-toggle-to-image:hover {
		background: var(--bg-tertiary);
		color: var(--text);
	}

	.drawio-placeholder {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 1rem;
		padding: 2rem;
		background: var(--bg-secondary);
		border: 2px dashed var(--border);
		border-radius: 8px;
		color: var(--text-muted);
	}

	.drawio-placeholder svg {
		opacity: 0.5;
	}

	.drawio-filename,
	.drawio-desc {
		font-family: var(--font-mono);
		font-size: 0.9rem;
		margin: 0;
		color: var(--text-muted);
	}

	.drawio-open-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		font-family: var(--font-mono);
		font-size: 0.85rem;
		color: var(--accent);
		background: var(--bg);
		border: 1px solid var(--accent);
		border-radius: 6px;
		text-decoration: none;
		transition: all 0.2s;
	}

	.drawio-open-btn:hover {
		background: var(--accent);
		color: white;
		text-decoration: none;
	}

	/* Theme toggle */
	.theme-toggle {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		background: transparent;
		border: 1px solid var(--border);
		border-radius: 6px;
		cursor: pointer;
		color: var(--text-muted);
		transition: all 0.2s;
		flex-shrink: 0;
	}

	.theme-toggle:hover {
		color: var(--accent);
		border-color: var(--accent);
	}

	/* Shiki dual theme: activate dark colors when data-theme="dark" */
	html[data-theme="dark"] .astro-code,
	html[data-theme="dark"] .astro-code span {
		color: var(--shiki-dark) !important;
		background-color: var(--shiki-dark-bg) !important;
	}
</style>