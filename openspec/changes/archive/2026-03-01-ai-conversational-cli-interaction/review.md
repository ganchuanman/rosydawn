# AI 交互层变更审查

## 1. TL;DR

本变更实现了 RosyDawn 博客系统的 AI 对话式交互层，让用户能够通过自然语言与 CLI 交互。核心功能包括 REPL 交互界面、AI 意图识别和知识库自动生成。使用 Mock Workflows 验证功能，为后续实现真实业务 Workflow 打下基础。

**关键决策**: 知识库在构建时生成（`npm run build:knowledge`），运行时快速加载，启动方式为 `npm run repl`（暂不配置独立命令）。

## 2. Core Changes

### 新增功能

- **REPL 交互界面**
  - 通过 `npm run repl` 启动交互式命令行
  - 支持优雅退出（Ctrl+C、Ctrl+D、exit/quit/q）
  - 友好的欢迎信息和输入提示

- **AI 意图识别**
  - 将自然语言解析为结构化意图（如 "创建文章" → `create_article`）
  - 置信度阈值判断（≥0.7 直接执行，<0.7 请求确认）
  - 多轮参数收集（缺失参数时主动询问）
  - 容错处理（超时、认证失败、响应格式错误）

- **知识库生成器**
  - 构建时自动提取 Workflow 元数据生成知识库
  - 支持静态知识补充（`knowledge/static.md`）
  - 开发模式实时生成，生产模式加载缓存

### 不实现（推迟到后续 Change）

- ❌ 真实业务 Workflow（Change 3: MVP）
- ❌ 独立命令行工具配置（后续 Change）
- ❌ 高级 CLI 功能（命令补全、历史搜索，Change 5: Polish）

## 3. Technical Highlights

### 架构决策

| 决策 | 选择 | 理由 |
|------|------|------|
| REPL 实现 | `@inquirer/prompts` | 项目已依赖，支持键盘快捷键和输入验证 |
| AI 意图识别 | Prompt Engineering + JSON 输出 | 兼容所有 OpenAI 兼容 API，无需额外训练 |
| 知识库构建时机 | 构建时生成 | 运行时快速加载，启动速度快 |
| 错误处理 | 分级处理（INFO/WARNING/ERROR/FATAL） | 用户引导式体验，避免崩溃 |

### 关键技术点

1. **置信度阈值机制**
   - 低置信度（<0.7）时提示用户确认，避免误识别
   - 示例：用户输入 "搞一下文章" → 系统请求确认

2. **多轮参数收集**
   - 用户输入 "创建文章"（缺少 topic）
   - 系统提示 "📝 请输入文章主题："
   - 用户输入 "WebSocket" → 参数补全
   - 支持取消操作（`cancel`）

3. **AI 响应容错**
   - 自动提取 ```json ``` 代码块
   - 解析失败时提示用户换种表达方式
   - 5 秒超时保护

4. **知识库双模式**
   - **生产环境**: 加载 `dist/knowledge-base.json`（<1 秒启动）
   - **开发环境**: 实时生成（最新 Workflow 元数据）

### Trade-offs

| 选择 | 优势 | 劣势 |
|------|------|------|
| 构建时生成知识库 | 启动快、性能好 | Workflow 更新后需手动构建 |
| 仅 Mock Workflow | 降低复杂度、专注交互层 | 无法测试真实业务场景 |
| 5 秒超时 | 避免用户长时间等待 | 可能误杀慢速 AI 服务 |

## 4. Quality Assurance Overview

### 测试覆盖

共设计 **32 个测试用例**，覆盖以下场景：

| 类别 | 数量 | 关键场景 |
|------|------|---------|
| REPL 交互 | 6 | 启动、退出、空输入 |
| AI 意图识别 | 11 | 高/低置信度、参数缺失、超时、认证失败 |
| 知识库生成 | 10 | 构建/加载、元数据提取、静态知识 |
| 集成与特殊 | 5 | 完整流程、边缘用例、性能、兼容性 |

### 主要风险点测试

✅ **AI 调用失败** (TC-15, TC-16, TC-17)
- 超时、认证失败、服务不可用都有降级方案

✅ **意图识别错误** (TC-11, TC-12)
- 低置信度请求确认，未知意图友好提示

✅ **参数缺失** (TC-09, TC-10)
- 多轮对话收集参数，支持取消

✅ **知识库异常** (TC-22, TC-26)
- 文件不存在时明确提示，静态知识可选

### 测试策略

```
单元测试: 60% (核心逻辑 - 意图识别、知识库生成)
集成测试: 30% (REPL + AI + Workflow 引擎协作)
手动测试: 10% (用户体验验证)
```

## 5. Impact & Risks

### BREAKING CHANGES

**无破坏性变更**。本 Change 为新增功能，不影响现有代码。

### 新增依赖

无需新增依赖，复用现有：
- `openai` (已存在)
- `@inquirer/prompts` (已存在)

### 配置要求

**必须配置环境变量**:
```bash
OPENAI_API_KEY=<your-api-key>
OPENAI_BASE_URL=<optional-custom-url>  # 可选，支持 Azure/DeepSeek/Ollama
```

### 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| AI 意图识别准确率低 | 用户体验差 | 置信度阈值 + Few-shot Examples + 用户反馈优化 |
| AI 调用延迟 | 交互不流畅 | 5 秒超时 + 加载动画 + 本地缓存（未来） |
| 知识库过大 | Prompt 超长 | Token 监控 + 文件大小警告（>50KB） |
| 多 AI 提供商兼容性 | 部分功能不可用 | 适配层模式 + 特性检测 + 降级策略 |

### 安全考虑

- ✅ API Key 从环境变量读取（不硬编码）
- ✅ 输入验证（防止注入攻击）
- ⚠️ 用户输入可能包含特殊字符（已测试，TC-29）

## 6. Review Focus

请审查者重点关注以下方面：

### 功能设计

- [ ] **置信度阈值 0.7** 是否合理？（`design.md` - Decision 2）
  - 太高可能导致频繁确认，太低可能误识别

- [ ] **5 秒超时** 是否合适？（`testcases.md` - TC-15）
  - 本地 Ollama 可能需要更长时间

- [ ] **多轮参数收集** 的交互流程是否符合预期？（`specs/ai-intent-recognizer/spec.md` - Requirement: 多轮参数收集）

### 架构决策

- [ ] **知识库构建时机** 是否合适？（`design.md` - Decision 3）
  - 当前: 构建时生成
  - 备选: 运行时检测文件变化自动刷新
  - 您认为用户更希望哪种方式？

- [ ] **Mock Workflow 标注方式** 是否清晰？（`specs/knowledge-generator/spec.md` - Requirement: Mock Workflow 元数据）
  - 当前: `[Mock]` 前缀 + `(仅用于测试)` 标注
  - 是否需要更明显的视觉区分？

### 测试覆盖

- [ ] **边缘用例** 是否充分？（`testcases.md` - TC-29, TC-31）
  - 特殊字符输入
  - 超长输入
  - 空闲状态

- [ ] **AI 服务不可用** 时的降级策略是否合理？（`testcases.md` - TC-16, TC-17）
  - 当前: 提示错误 + 建议使用命令行模式
  - 是否需要自动降级到传统 CLI？

### 用户体验

- [ ] **欢迎信息** 内容是否合适？（`specs/repl-interface/spec.md` - Requirement: REPL 启动脚本）
  - 需要包含哪些信息？版本号、快速开始、帮助链接？

- [ ] **错误提示** 是否足够友好？（`specs/ai-intent-recognizer/spec.md` - Requirement: 错误处理）
  - 示例: "AI 服务暂时不可用，建议使用命令行模式绕过 AI"

### 实现优先级

- [ ] **是否需要调整任务顺序？**（将在 `tasks.md` 中定义）
  - 建议: REPL 基础 → AI 意图识别 → 知识库生成 → 集成测试
  - 您认为哪个组件应该优先实现？

---

## 审查清单

- [ ] 功能设计合理性和完整性
- [ ] 技术决策的正确性
- [ ] 测试覆盖的充分性
- [ ] 风险评估的准确性
- [ ] 用户体验的流畅性
- [ ] 与 Change 1 (core) 的集成方案

**请于 [日期] 前完成审查，如有疑问请在评论中标注 `@author`。**
