# Review Synthesis

## 1. TL;DR

为 PlantUML 图片渲染添加完整的加载状态管理系统，包括 loading 动画、失败错误提示和手动重试功能。通过引入 CSS 类名控制的状态机制（`.plantuml-loading`、`.plantuml-error`、`.plantuml-loaded`），在不影响现有图片/源码切换功能的前提下，显著提升用户体验，特别是在网络不稳定或服务器响应慢的场景下。

## 2. Core Changes

### 新增能力
- **plantuml-loading-states**: 完整的加载状态管理
  - Loading 动画显示（纯 CSS 旋转 spinner）
  - 错误状态提示界面（错误图标 + 提示文字 + 重试按钮）
  - 手动重试功能（2 秒防抖机制）
  - 30 秒超时自动触发错误状态
  - View Transitions 导航兼容性
  - 暗色模式样式支持

### 修改能力
- **plantuml-url-encoder**: 增强 HTML 结构以支持状态管理
  - 在 `.plantuml-image-wrapper` 中添加三个状态容器
  - 默认添加 `.plantuml-loading` 状态类
  - 通过 CSS 类名控制状态显示/隐藏

## 3. Technical Highlights

### 关键技术决策

| 决策点 | 选择方案 | 理由 |
|--------|---------|------|
| **状态控制机制** | CSS 类名（`.plantuml-loading/error/loaded`） | 与现有 `data-state="image/code"` 正交，避免冲突，灵活可组合 |
| **Loading 动画** | 纯 CSS Spinner | 零额外资源请求，性能最优，实现简单 |
| **加载监听方式** | JavaScript `Image` 对象 | 兼容性好，支持后台预加载，易于实现重试 |
| **超时时间** | 30 秒 | 平衡用户体验和网络波动，适合复杂图表 |
| **重试机制** | 手动重试 + 2 秒防抖 | 用户可控，避免加重服务器负担 |

### 架构设计

```
.plantuml-container
├── [data-state="image"] (现有切换机制)
├── .plantuml-loading/error/loaded (新增状态类)
└── .plantuml-image-wrapper
    ├── .plantuml-loading-container (loading 动画)
    ├── .plantuml-error-container (错误提示 + 重试按钮)
    └── .plantuml-image (实际图片)
```

**状态转换流程**：
1. 初始：`.plantuml-loading` → 显示 spinner
2. 成功：`.plantuml-loaded` → 显示图片
3. 失败：`.plantuml-error` → 显示错误提示
4. 重试：`.plantuml-error` → `.plantuml-loading` → 循环

### 实现要点

1. **HTML 结构生成**（构建时）
   - 在 PlantUML 插件中生成包含状态容器的 HTML
   - 默认添加 `.plantuml-loading` 类

2. **CSS 样式**（Layout.astro）
   - 根据状态类名显示/隐藏对应容器
   - 纯 CSS spinner 动画（`@keyframes`）
   - 暗色模式适配（`html[data-theme="dark"]`）

3. **JavaScript 逻辑**（Layout.astro）
   - 使用 `Image` 对象监听加载事件
   - 30 秒超时计时器
   - 状态类名切换（互斥性保证）
   - 重试按钮防抖（2 秒）
   - View Transitions 事件处理

## 4. Quality Assurance Overview

### 测试覆盖率
- **总测试用例**: 30 个
- **自动化测试**: 14 个（单元 + E2E）
- **手动测试**: 10 个（UI + 视觉验证）
- **边缘案例**: 4 个（多图片、快速导航、缓存、可访问性）

### 测试重点

| 测试类型 | 覆盖场景 | 关键测试点 |
|---------|---------|-----------|
| **功能测试** | Loading → Loaded → Error | 状态转换正确性、超时触发、重试成功/失败 |
| **兼容性测试** | View Transitions 导航 | 页面切换时状态重置、事件监听清理 |
| **样式测试** | 暗色模式 | 所有状态下的视觉一致性、hover 状态 |
| **边缘案例** | 多图片、快速导航、缓存 | 独立性、无内存泄漏、缓存处理 |

### 高风险测试场景
1. **TC-06**: 超时触发测试（需要 throttling 工具）
2. **TC-10**: 重试按钮防抖验证（自动化）
3. **TC-15-16**: View Transitions 兼容性（E2E）
4. **TC-28**: 快速导航时的状态处理（内存泄漏风险）

## 5. Impact & Risks

### 无破坏性变更
✅ 所有修改向后兼容，不影响现有功能

### 受影响的文件
- **PlantUML 插件**: 修改 HTML 结构生成逻辑
- **Layout.astro**: 添加 CSS 样式和 JavaScript 逻辑
- **无后端变更**: 仅前端改动

### 主要风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **View Transitions 冲突** | 页面切换时状态丢失 | 使用事件委托 + `astro:page-load` 重新初始化 |
| **频繁重试增加服务器压力** | PlantUML 服务器负担 | 手动重试 + 2 秒防抖，不自动重试 |
| **CSS 样式影响现有布局** | 图片容器布局错乱 | 绝对定位状态容器，保持相同尺寸 |
| **超时计时器未清理** | 内存泄漏 | 导航离开时清理所有监听器和计时器 |

### 性能影响
- **正面**: 零额外资源请求（纯 CSS 动画）
- **中性**: 轻微的 DOM 结构增加（3 个状态容器）
- **可忽略**: JavaScript 监听开销（每图片约 1-2 个事件监听器）

## 6. Review Focus

请各位审查者重点关注以下方面：

### 产品经理 / UX 设计师
- [ ] **错误提示文案**：当前为"图片加载失败，请检查网络连接后重试"，是否需要调整？
- [ ] **Loading 动画效果**：纯 CSS 旋转 spinner 是否符合设计规范？
- [ ] **重试按钮文案**：使用"重新加载"是否清晰？
- [ ] **超时时间**：30 秒是否合理？是否需要根据图表复杂度调整？

### 技术负责人
- [ ] **状态管理机制**：CSS 类名 + `data-state` 双重机制是否过度复杂？
- [ ] **性能影响**：30 个测试用例是否足够？是否需要性能基准测试？
- [ ] **兼容性**：是否需要支持 IE11 或其他旧版浏览器？
- [ ] **可维护性**：JavaScript 逻辑内联在 Layout.astro 中是否合适？是否需要抽离为独立模块？

### QA 工程师
- [ ] **测试覆盖度**：边缘案例 TC-27~TC-30 是否足够？是否需要增加其他场景？
- [ ] **自动化测试**：14 个自动化测试用例是否能覆盖核心功能？
- [ ] **浏览器兼容性**：是否需要在 Safari、Firefox 上进行额外测试？
- [ ] **暗色模式测试**：所有状态在暗色模式下的视觉验证是否充分？

### 前端开发
- [ ] **CSS 架构**：状态类命名（`.plantuml-loading/error/loaded`）是否合理？是否会与其他样式冲突？
- [ ] **事件处理**：使用事件委托处理动态创建的按钮是否可靠？
- [ ] **内存管理**：View Transitions 导航时是否正确清理了所有监听器和计时器？
- [ ] **代码复用**：重试逻辑是否可以抽离为通用组件，用于其他图片加载场景？

### 待讨论的问题
1. **重试按钮的防抖时间**：2 秒是否合适？是否需要可配置？
2. **超时错误提示**：是否需要区分"网络错误"和"超时错误"的提示文案？
3. **无障碍访问**：是否需要为 loading/error 状态添加 ARIA 标签？
4. **未来扩展**：是否考虑支持自动重试（指数退避）或本地缓存？

---

**下一步行动**：审查通过后，运行 `/opsx:apply` 开始实现任务。
