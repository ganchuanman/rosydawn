## Context

当前 PlantUML 图片渲染采用直接在浏览器中请求 PlantUML 服务器的方式，使用 `<img>` 标签加载 SVG/PNG 图片。现有功能包括：
- Markdown 构建时将 PlantUML 代码块编码为 URL
- 客户端支持图片/源码视图切换
- 支持暗色模式和 View Transitions 导航

**当前痛点**：
- 图片加载过程中无任何反馈，用户体验差
- 网络问题或服务器故障时，图片加载失败但无明确提示
- 失败后无法重试，需要刷新整个页面
- 缺少超时机制，可能导致无限等待

**约束条件**：
- 必须保持与现有图片/源码切换功能的兼容性
- 不能影响构建时的 URL 编码逻辑
- 需要支持 Astro View Transitions
- 必须支持暗色模式

## Goals / Non-Goals

**Goals:**
- 为 PlantUML 图片添加 loading 状态，提供清晰的视觉反馈
- 添加加载失败时的错误提示界面
- 实现失败后的重试功能，无需刷新页面
- 添加加载超时机制（建议 30 秒）
- 保持现有图片/源码切换功能完全不受影响
- 确保暗色模式下的样式一致性

**Non-Goals:**
- 不修改构建时的 PlantUML URL 编码逻辑
- 不添加图片缓存或本地存储功能
- 不实现自动重试机制（仅支持手动重试）
- 不添加加载进度条（仅显示 loading 动画）

## Decisions

### Decision 1: 使用 CSS 类名控制状态显示

**选择方案**: 使用 CSS 类名（`.plantuml-loading`、`.plantuml-error`、`.plantuml-loaded`）控制不同状态的显示

**替代方案**:
1. ❌ 使用 `data-state` 属性（与现有的 image/code 状态冲突）
2. ❌ 每个状态独立的 DOM 元素（增加复杂度）

**理由**:
- 与现有的 `data-state="image/code"` 机制正交，不会冲突
- CSS 类名更灵活，可以组合使用
- 易于通过 JavaScript 添加/移除

### Decision 2: Loading 动画采用 CSS Spinner

**选择方案**: 使用纯 CSS 实现的旋转 spinner 动画

**替代方案**:
1. ❌ SVG 动画图标（增加额外资源请求）
2. ❌ 第三方动画库（过度工程化）
3. ✅ 骨架屏（适合文本内容，不适合图片）

**理由**:
- 零额外资源请求，性能最优
- 与现有设计风格一致
- 实现简单，易于维护

### Decision 3: 图片加载状态监听使用 Image 对象

**选择方案**: 使用 JavaScript `Image` 对象监听加载事件，而非直接监听 `<img>` 元素

**替代方案**:
1. ❌ 直接监听 `<img>` 元素的 load/error 事件（部分浏览器兼容性问题）
2. ❌ 使用 Intersection Observer（过度复杂）

**理由**:
- 兼容性好，所有浏览器支持
- 可以在后台预加载，不阻塞渲染
- 易于实现重试功能（创建新的 Image 对象）

### Decision 4: 超时时间设置为 30 秒

**选择方案**: 30 秒超时限制

**替代方案**:
1. ❌ 10 秒（可能太短，特别是复杂图表）
2. ❌ 60 秒（可能太长，用户体验差）

**理由**:
- PlantUML 官方服务器通常在 5-10 秒内完成
- 30 秒足以应对网络波动和复杂图表
- 与业界标准加载超时时间一致

### Decision 5: 错误界面包含重试按钮和说明文字

**选择方案**: 错误界面显示错误图标、提示文字和重试按钮

**替代方案**:
1. ❌ 仅显示重试按钮（缺少上下文）
2. ❌ 自动重试（可能加重服务器负担）

**理由**:
- 明确告知用户发生了什么
- 提供可操作的解决方案
- 用户可控，不会意外触发多次请求

## Risks / Trade-offs

### Risk 1: Loading 状态可能与 View Transitions 冲突
- **风险**: Astro View Transitions 在页面切换时可能重新初始化脚本，导致 loading 状态丢失
- **缓解措施**:
  - 使用事件委托机制，不依赖页面加载事件
  - 在 `astro:page-load` 事件中重新初始化图片监听
  - 将状态管理代码放在 Layout.astro 中，确保全局可用

### Risk 2: 频繁重试可能加重 PlantUML 服务器负担
- **风险**: 用户可能频繁点击重试按钮，导致服务器压力增加
- **缓解措施**:
  - 不实现自动重试，仅支持手动触发
  - 可考虑在重试按钮上添加防抖（debounce，如 2 秒内不可重复点击）
  - 未来可考虑添加本地缓存（不在本次范围内）

### Risk 3: CSS 样式可能影响现有布局
- **风险**: 新增的 loading 和 error 容器可能影响现有图片布局
- **缓解措施**:
  - 使用绝对定位，不影响文档流
  - 保持容器尺寸与图片一致
  - 在暗色模式下测试样式兼容性

### Trade-off: 不实现加载进度条
- **取舍**: 仅显示 loading 动画，不显示具体进度
- **理由**: PlantUML 服务器不提供进度信息，无法获取真实加载进度
- **影响**: 用户无法知道还需等待多久，但实现复杂度大大降低

## Migration Plan

### 实施步骤

**Phase 1: HTML 结构调整**
1. 修改 PlantUML 插件输出，在 `.plantuml-image-wrapper` 中添加状态容器
2. 添加 loading、error、loaded 三种状态的 HTML 结构
3. 默认显示 loading 状态

**Phase 2: CSS 样式添加**
1. 在 Layout.astro 中添加 loading spinner 样式
2. 添加 error 界面样式（错误图标、提示文字、重试按钮）
3. 添加状态切换的过渡动画
4. 确保暗色模式下的样式一致性

**Phase 3: JavaScript 逻辑实现**
1. 在 Layout.astro 中添加图片加载监听逻辑
2. 使用 `Image` 对象预加载图片
3. 根据加载结果切换状态类名
4. 实现重试按钮的点击事件处理
5. 添加 30 秒超时机制

**Phase 4: View Transitions 兼容**
1. 确保脚本在 `astro:page-load` 事件中重新初始化
2. 使用事件委托处理动态创建的元素
3. 测试页面导航时的状态保持

**Phase 5: 测试验证**
1. 测试正常加载流程
2. 测试网络失败场景
3. 测试超时场景
4. 测试重试功能
5. 测试暗色模式
6. 测试 View Transitions 导航

### 回滚策略
- 所有修改仅在 Layout.astro 和 PlantUML 插件中
- 如遇严重问题，可快速回滚到当前版本
- CSS 和 JS 相对独立，可单独回滚

## Open Questions

1. **重试按钮的防抖时间设置多少合适？**
   - 建议: 2-3 秒
   - 需要在用户体验和服务器压力之间平衡

2. **是否需要为 loading 状态添加取消按钮？**
   - 当前设计: 不添加，用户可以切换到源码视图
   - 未来考虑: 如果用户反馈强烈，可以添加

3. **错误提示文字应该如何表述？**
   - 建议: "图片加载失败，请检查网络连接后重试"
   - 需要考虑国际化（当前仅支持中文）

4. **是否需要在控制台输出详细的加载日志？**
   - 建议: 仅在开发环境输出，生产环境静默
   - 有助于调试，但不影响用户体验
