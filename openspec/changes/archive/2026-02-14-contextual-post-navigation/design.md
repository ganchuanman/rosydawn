## Context

当前博客系统已经在 `src/pages/blog/[...slug].astro` 中实现了上一篇/下一篇导航功能。导航数据在 `getStaticPaths` 中构建时生成，基于全局文章时间顺序。客户端 JavaScript（第 126-144 行）负责在用户通过导航切换文章时保持来源参数（`from` 和 `ref`）。

**当前架构**:
- 静态生成：导航数据在构建时嵌入 HTML
- 客户端增强：JavaScript 动态添加来源参数到导航链接
- 来源识别：基于 URL 查询参数 `from` 和 `ref`（已在 `smart-back-button` spec 中定义）

**利益相关者**:
- 博客访客：期望导航行为符合直觉
- 开发者：需要维护简洁的代码逻辑

## Goals / Non-Goals

**Goals**:
- 根据来源类型控制导航可见性，提升用户体验
- 保持现有架构的简洁性（静态生成 + 客户端增强）
- 复用已有的来源识别机制（`from` 参数）
- 保持向后兼容性（无破坏性变更）

**Non-Goals**:
- 不实现基于标签的上下篇导航（虽然更符合直觉，但需要大量重构）
- 不修改 `getStaticPaths` 的数据生成逻辑
- 不改变导航的时间排序规则
- 不修改来源参数传递机制

## Decisions

### 决策 1: 在客户端层面控制导航可见性

**方案**: 在客户端 JavaScript 中检测 `from` 参数，动态显示/隐藏导航。

**理由**:
- **简单性**: 仅需修改现有的客户端脚本（第 78-97 行已渲染导航 HTML）
- **性能**: 静态 HTML 保持不变，无额外的构建时计算
- **一致性**: 与现有的来源参数保持机制（第 126-144 行）使用相同模式
- **渐进增强**: 即使 JavaScript 未加载，导航仍然可见（降级到默认行为）

**替代方案**:
- **服务端渲染（通过 props 传递）**: 需要修改 `getStaticPaths` 和组件 props，增加复杂度
- **构建时生成多版本 HTML**: 为每种来源类型生成不同版本，导致构建时间和产物大小增加

### 决策 2: 使用 CSS 控制可见性而非 DOM 移除

**方案**: 添加/移除 CSS class（如 `.hidden`）来控制导航显示，而非直接操作 DOM。

**理由**:
- **性能**: CSS 切换比 DOM 操作更快
- **可维护性**: 代码更简洁，易于理解
- **可扩展性**: 未来可以添加过渡动画（如 fade in/out）

**实现**:
```javascript
const nav = document.querySelector('.post-nav');
const shouldShowNav = !from || from === 'home' || from === 'blog-list';
if (nav) {
  nav.style.display = shouldShowNav ? '' : 'none';
}
```

### 决策 3: 默认显示导航（宽松策略）

**方案**: 只有明确识别为 `from=tag-detail` 时才隐藏导航，其他情况（包括无参数）都显示。

**理由**:
- **容错性**: 无法识别来源时显示导航，避免误删功能
- **一致性**: 与 `smart-back-button` 的默认行为一致（无参数时返回首页）
- **用户体验**: 显示导航比隐藏导航的负面影响更小

**来源类型映射**:
- `home` → 显示导航
- `blog-list` → 显示导航
- `tag-detail` → 隐藏导航
- 无参数/其他 → 显示导航（默认）

## Risks / Trade-offs

### 风险 1: JavaScript 未加载时的降级行为

**风险**: 如果用户浏览器禁用 JavaScript 或脚本加载失败，从标签页进入时仍会显示导航。

**影响**: 低。大多数用户浏览器启用 JavaScript，且显示导航不会破坏功能，只是体验稍差。

**缓解措施**:
- 确保脚本加载顺序正确（现有代码已处理）
- 在文档中说明降级行为

### 风险 2: 客户端可见性控制可能导致短暂的闪烁

**风险**: 页面加载时，导航先显示后隐藏，可能产生视觉闪烁。

**影响**: 中等。在慢速网络或低性能设备上可能较明显。

**缓解措施**:
- 在 `<head>` 中添加内联 CSS，根据 URL 参数预先设置导航隐藏
- 或者接受轻微闪烁，因为大多数用户不会从标签页进入

**推荐方案**: 初期实现接受轻微闪烁，如果用户反馈强烈，再添加预隐藏逻辑。

### 权衡: 简洁性 vs 功能完整性

**权衡**: 选择简单的客户端方案，放弃了"标签上下篇导航"的更佳体验。

**理由**:
- 实现标签上下篇需要修改 `getStaticPaths`，为每篇文章生成多个版本（全局版本 + 每个标签版本）
- 大幅增加构建复杂度和时间
- 当前方案已足够解决用户的困惑（从标签进入时不显示导航）

**未来扩展**: 如果用户强烈需要标签上下篇导航，可以在后续版本中实现，届时需要重新设计数据结构。

## Migration Plan

### 部署步骤

1. **修改客户端脚本** (`src/pages/blog/[...slug].astro`):
   - 在 `astro:page-load` 事件中，检测 `from` 参数
   - 根据来源类型设置导航可见性
   - 保持现有的来源参数传递逻辑不变

2. **测试**:
   - 从首页进入文章 → 显示导航
   - 从列表页进入文章 → 显示导航
   - 从标签页进入文章 → 隐藏导航
   - 直接访问文章 URL（无参数） → 显示导航
   - 通过导航切换文章 → 可见性保持不变

3. **部署**:
   - 提交代码到 Git 仓库
   - 触发构建和部署流程
   - 验证生产环境行为

### 回滚策略

如果发现严重问题：
1. 回滚 Git 提交
2. 重新构建和部署
3. 无需数据迁移或配置更改（纯前端变更）

### 监控指标

- 无特定监控指标（纯前端 UI 变更）
- 可通过用户反馈或 Hotjar 等工具观察用户行为

## Open Questions

无。当前设计已足够明确，可以直接实施。

**后续优化机会**（非当前范围）:
- 如果用户反馈需要，可以实现"标签上下篇导航"功能
- 可以添加导航显示/隐藏的过渡动画
- 可以在导航区域显示来源提示（如"您正在浏览标签 vue 下的文章"）
